<section class="section agreement-detail-card" fxLayout="column" fxLayoutAlign="center center">
  <div>
    <h2>{{ vm.itemDetails.name }}</h2>
    <span class="quantity-prefix">x</span><span>{{ formatItemDetails(vm.itemDetails) }}</span>
    <h3
      class="sub-title status-text"
      [ngClass]="{
        'is-pending': vm.itemDetails.status === status.FindingMatch,
        'is-matched': vm.itemDetails.status === status.NewMatchFound,
        'is-confirmed': vm.itemDetails.status === status.OrderConfirmed,
        'is-fulfilled': vm.itemDetails.status === status.OrderFulfilled,
        'is-cancelled': vm.itemDetails.status === status.OrderCancelled
      }"
    >
      <strong>{{ vm.itemDetails.statusDisplay }}</strong>
    </h3>

    <p *ngIf="vm.itemDetails.sharerName" class="name body-copy">You matched with {{ vm.itemDetails.sharerName }}!</p>

    <p class="body-copy">{{ vm.itemDetails.dialogMessage }}</p>
    <!-- 
        <h3 class="sub-title">{{ vm.itemDetails.addressLabel }}</h3>
        <p class="body-copy">{{ vm.itemDetails.deliveryAddress ? vm.itemDetails.deliveryAddress : '--' }}</p> -->

    <!-- Chat Log -->
    <h3>Messages</h3>
    <div *ngIf="vm.itemDetails.orderNotes && vm.itemDetails.orderNotes.length; else nonotes">
      <div
        class="chat-entry"
        *ngFor="let note of vm.itemDetails.orderNotes; trackBy: trackByNotes"
        [ngClass]="{
          'is-user-message': note.userId === vm.userId,
          'is-guest-message': note.userId !== vm.userId
        }"
      >
        <p class="author">{{ note.createdBy }}</p>
        <div class="chat-body">
          <div *ngIf="note.imageUrl == null; else imageNote">{{ note.noteBody }}</div>
          <ng-template #imageNote>
            <div>
              <app-item-image-canvas [imageUrl]="note.imageUrl"></app-item-image-canvas>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
    <ng-template #nonotes>
      <p><i>No messages yet...</i></p>
    </ng-template>
    <!-- new message pending animation -->
    <div *ngIf="vm.newMessagePending" class="wave-animation">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </div>

    <!-- Chat Input -->
    <div
      data-chat-input
      class="input-area"
      fxLayout="row"
      fxLayoutAlign="start center"
      *ngIf="vm.itemDetails.status !== status.OrderFulfilled && vm.itemDetails.status !== status.OrderCancelled"
    >
      <mat-form-field appearance="outline">
        <textarea
          matInput
          [formControl]="orderNoteFC"
          cdkTextareaAutosize
          #autosize="cdkTextareaAutosize"
          cdkAutosizeMinRows="3"
          cdkAutosizeMaxRows="10"
        >
        </textarea>
      </mat-form-field>

      <div data-send-btn>
        <button class="primary send-btn" mat-button color="primary" [disabled]="orderNoteFC.value === ''" (click)="onSubmitEdit()">
          <mat-icon>send</mat-icon>
        </button>
      </div>
    </div>
    <div
      fxLayout="row"
      fxLayoutAlign="end center"
      *ngIf="vm.itemDetails.status !== status.OrderFulfilled && vm.itemDetails.status !== status.OrderCancelled"
    >
      <div class="item-request__photo-actions">
        <mat-icon class="cameraicon" (click)="addpicture()" *ngIf="!showImageArea">camera_alt</mat-icon>
        <mat-icon class="cameraicon" (click)="hidepicture()" *ngIf="showImageArea">close</mat-icon>
      </div>
    </div>

    <div>
      <app-item-takepicture
        *ngIf="showImageArea"
        [agreement]="vm.itemDetails"
        [imagename]="imagename"
        [showImageArea]="showImageArea"
        (picturetakenEvent)="pictureTaken()"
      ></app-item-takepicture>
    </div>

    <div class="actions" fxLayout="row" fxLayoutAlign="start center">
      <button
        *ngIf="vm.itemDetails.status !== status.OrderCancelled && vm.itemDetails.status === status.FindingMatch"
        mat-button
        mat-flat-button
        color="warn"
        (click)="onCancelMatch(vm.itemDetails)"
      >
        Cancel Request
      </button>
      <button
        *ngIf="vm.itemDetails.status !== status.OrderCancelled && vm.itemDetails.status !== status.Fulfilled"
        mat-button
        mat-flat-button
        color="warn"
        (click)="onCancelMatch(vm.itemDetails)"
      >
        {{ vm.itemDetails.status === status.NewMatchFound ? 'Cancel Match' : 'Cancel Delivery' }}
      </button>
    </div>
  </div>
</section>

<div class="page-footer mat-elevation-z5" fxLayout="row" fxLayoutAlign="center center">
  <a mat-button class="nav-action btn cce" mat-fab color="primary" routerLink="/dashboard">
    <mat-icon class="cce-white">arrow_back</mat-icon>
  </a>
</div>
